"use strict";
var __assign = (this && this.__assign) || function () {
    __assign = Object.assign || function(t) {
        for (var s, i = 1, n = arguments.length; i < n; i++) {
            s = arguments[i];
            for (var p in s) if (Object.prototype.hasOwnProperty.call(s, p))
                t[p] = s[p];
        }
        return t;
    };
    return __assign.apply(this, arguments);
};
var __createBinding = (this && this.__createBinding) || (Object.create ? (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    Object.defineProperty(o, k2, { enumerable: true, get: function() { return m[k]; } });
}) : (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    o[k2] = m[k];
}));
var __setModuleDefault = (this && this.__setModuleDefault) || (Object.create ? (function(o, v) {
    Object.defineProperty(o, "default", { enumerable: true, value: v });
}) : function(o, v) {
    o["default"] = v;
});
var __importStar = (this && this.__importStar) || function (mod) {
    if (mod && mod.__esModule) return mod;
    var result = {};
    if (mod != null) for (var k in mod) if (k !== "default" && Object.prototype.hasOwnProperty.call(mod, k)) __createBinding(result, mod, k);
    __setModuleDefault(result, mod);
    return result;
};
var __rest = (this && this.__rest) || function (s, e) {
    var t = {};
    for (var p in s) if (Object.prototype.hasOwnProperty.call(s, p) && e.indexOf(p) < 0)
        t[p] = s[p];
    if (s != null && typeof Object.getOwnPropertySymbols === "function")
        for (var i = 0, p = Object.getOwnPropertySymbols(s); i < p.length; i++) {
            if (e.indexOf(p[i]) < 0 && Object.prototype.propertyIsEnumerable.call(s, p[i]))
                t[p[i]] = s[p[i]];
        }
    return t;
};
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.Avatar = void 0;
var auto_id_1 = require("@reach/auto-id");
var react_1 = __importStar(require("react"));
var react_is_1 = __importDefault(require("react-is"));
var styled_components_1 = __importDefault(require("styled-components"));
var hooks_1 = require("../../hooks");
var theme_1 = require("../../theme");
var text_1 = require("../text");
var styles_1 = require("./styles");
var Root = styled_components_1.default.div(styles_1.responsiveAvatarSizeStyle, styles_1.avatarStyle.root);
var Arrow = styled_components_1.default.div(styles_1.avatarStyle.arrow);
var BgStroke = styled_components_1.default.ellipse(styles_1.avatarStyle.bgStroke);
var Stroke = styled_components_1.default.ellipse(styles_1.avatarStyle.stroke);
var Initials = styled_components_1.default.div(styles_1.avatarStyle.initials);
exports.Avatar = react_1.forwardRef(function (props, ref) {
    var asProp = props.as, _a = props.color, colorKey = _a === void 0 ? 'gray' : _a, src = props.src, title = props.title, initials = props.initials, onImageLoadError = props.onImageLoadError, arrowPositionProp = props.arrowPosition, animateArrowFrom = props.animateArrowFrom, _b = props.status, status = _b === void 0 ? 'online' : _b, sizeProp = props.size, restProps = __rest(props, ["as", "color", "src", "title", "initials", "onImageLoadError", "arrowPosition", "animateArrowFrom", "status", "size"]);
    var as = react_is_1.default.isValidElementType(asProp) ? asProp : 'div';
    var size = hooks_1.useResponsiveProp(sizeProp, [0]);
    var theme = theme_1.useTheme();
    var color = theme.sanity.color.spot[colorKey] || theme.sanity.color.spot.gray;
    // @todo: remove this
    var avatarSize = theme.sanity.avatar.sizes[size[0]] || theme.sanity.avatar.sizes[0];
    var _sizeRem = avatarSize.size;
    var _radius = _sizeRem / 2;
    var elementId = auto_id_1.useId() || '';
    var _c = react_1.useState(animateArrowFrom || arrowPositionProp || 'inside'), arrowPosition = _c[0], setArrowPosition = _c[1];
    var _d = react_1.useState(false), imageFailed = _d[0], setImageFailed = _d[1];
    var imageId = "avatar-image-" + elementId;
    react_1.useEffect(function () {
        if (arrowPosition === arrowPositionProp)
            return undefined;
        // Start animation in the next frame
        var raf = requestAnimationFrame(function () { return setArrowPosition(arrowPositionProp); });
        return function () { return cancelAnimationFrame(raf); };
    }, [arrowPosition, arrowPositionProp]);
    react_1.useEffect(function () {
        if (src)
            setImageFailed(false);
    }, [src]);
    var handleImageError = react_1.useCallback(function () {
        setImageFailed(true);
        if (onImageLoadError) {
            onImageLoadError(new Error('Avatar: the image failed to load'));
        }
    }, [onImageLoadError]);
    return (react_1.default.createElement(Root, __assign({ as: as, "data-as": typeof as === 'string' ? as : undefined, "data-ui": "Avatar" }, restProps, { "$size": size, "$color": color, "aria-label": title, "data-arrow-position": arrowPosition, "data-status": status, ref: ref, title: title }),
        react_1.default.createElement(Arrow, null,
            react_1.default.createElement("svg", { width: "11", height: "7", viewBox: "0 0 11 7", fill: "none" },
                react_1.default.createElement("path", { d: "M6.67948 1.50115L11 7L0 7L4.32052 1.50115C4.92109 0.736796 6.07891 0.736795 6.67948 1.50115Z", fill: color }))),
        !imageFailed && src && (react_1.default.createElement("svg", { viewBox: "0 0 " + _sizeRem + " " + _sizeRem, fill: "none" },
            react_1.default.createElement("defs", null,
                react_1.default.createElement("pattern", { id: imageId, patternContentUnits: "objectBoundingBox", width: "1", height: "1" },
                    react_1.default.createElement("image", { href: src, width: "1", height: "1", onError: handleImageError }))),
            react_1.default.createElement("circle", { cx: _radius, cy: _radius, r: _radius, fill: "url(#" + imageId + ")" }),
            react_1.default.createElement(BgStroke, { cx: _radius, cy: _radius, rx: _radius, ry: _radius, vectorEffect: "non-scaling-stroke" }),
            react_1.default.createElement(Stroke, { cx: _radius, cy: _radius, rx: _radius, ry: _radius, stroke: color, vectorEffect: "non-scaling-stroke" }))),
        (imageFailed || !src) && initials && (react_1.default.createElement(react_1.default.Fragment, null,
            react_1.default.createElement(Initials, null,
                react_1.default.createElement(text_1.Text, { as: "span", size: size.map(function (s) { return (s === 0 ? 0 : s + 1); }) },
                    react_1.default.createElement("strong", null, initials)))))));
});
exports.Avatar.displayName = 'Avatar';
//# sourceMappingURL=avatar.js.map